{"componentChunkName":"component---node-modules-gatsby-theme-portfolio-minimal-src-templates-article-index-tsx","path":"/eternal-blue/","result":{"pageContext":{"article":{"banner":{"alt":"Ocean image","caption":"Photo by <a href=\"https://unsplash.com/@tarafuco\">Tanja Cotoaga</a> on Unsplash","src":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wgARCAAMABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAYKCAn/xAAVAQEBAAAAAAAAAAAAAAAAAAAHBv/aAAwDAQACEAMQAAABV9P8BmGiFKVydYPk3//EABsQAAICAwEAAAAAAAAAAAAAAAMEBQYAAQIW/9oACAEBAAEFAom+VTIm9U7FL9W+QJsGKUTjPTPqZQG//8QAIREAAgICAQQDAAAAAAAAAAAAAQIDBBEhBQAGEhMUMTL/2gAIAQMBAT8B42i3BTMYaHbsrYRy54OhDIB7EwokrVoS2M68tD7GD1X7ssCCIfBrDEajCTWI1GAPyit4qujhRoDXX//EACMRAAICAQMDBQAAAAAAAAAAAAECAxEFBCIxAAYSExUhMkH/2gAIAQIBAT8ByE7ZQenJr85F4RM9LltZKlUR9Z55Pmuaq+Ca6n7VdppG9zm3OW3xaeRtxBHk7xFnajuZrJN8/v8A/8QAKBAAAgEDAQYHAQAAAAAAAAAAAQIDBBESABNBUVJhgQUUITEycZHC/9oACAEBAAY/AkE/gVOoO+Spmf8AgHSYUdCjBT8XfPZ9XZQ/3w0gjpolTcI53C9sI7d/3QLyHlt7ADppk2zgKFKlWsym1/Q6aJvLVOBxEtTBnNiAAAzq0eduZ7vxa1gP/8QAGhABAQEBAQEBAAAAAAAAAAAAAREhMQBBUf/aAAgBAQABPyGJgQQWEY/Z3974Tioy8YK36qAQh2PnX8xuh1G1bmh88jsCUDg4+T7ih2IdGnegsTxwl6mXfMsBrEHp/9oADAMBAAIAAwAAABDE7//EABcRAQEBAQAAAAAAAAAAAAAAAAERIQD/2gAIAQMBAT8QgDw5pFyRg1pgCciYQIoYLCigZ3//xAAYEQEBAQEBAAAAAAAAAAAAAAABESEAQf/aAAgBAgEBPxBztRNTZAevDLCiiWEqTBYjRSLS8//EABgQAQEBAQEAAAAAAAAAAAAAAAERIQAx/9oACAEBAAE/EF2FjZQT0hSyEFMJYsCpKY9YC4VTj5tILYox6FaAIZ/GiEDGDAVPZPKcCbpGUXTAGyFAhBxnbQHBUfLrz//Z"},"images":{"fallback":{"src":"/static/c2bcd907622a9040da92b03a17b9f733/91671/eternal-blue.jpg","srcSet":"/static/c2bcd907622a9040da92b03a17b9f733/7e3b4/eternal-blue.jpg 165w,\n/static/c2bcd907622a9040da92b03a17b9f733/47f88/eternal-blue.jpg 330w,\n/static/c2bcd907622a9040da92b03a17b9f733/91671/eternal-blue.jpg 660w,\n/static/c2bcd907622a9040da92b03a17b9f733/5aaff/eternal-blue.jpg 1320w","sizes":"(min-width: 660px) 660px, 100vw"},"sources":[{"srcSet":"/static/c2bcd907622a9040da92b03a17b9f733/322ad/eternal-blue.webp 165w,\n/static/c2bcd907622a9040da92b03a17b9f733/de3b3/eternal-blue.webp 330w,\n/static/c2bcd907622a9040da92b03a17b9f733/2b2b5/eternal-blue.webp 660w,\n/static/c2bcd907622a9040da92b03a17b9f733/e36a7/eternal-blue.webp 1320w","type":"image/webp","sizes":"(min-width: 660px) 660px, 100vw"}]},"width":660,"height":400}}}},"body":"<h1>Que aprendi de la maquina Blue</h1>\n<h2>Nmap default scripts are not vuln</h2>\n<p>Nmap utiliza default scripts, esto significa que no descubrira vectores vulnerables como EternalBlue con el flag -sCV.</p>\n<p>Para descubrir vectores conocidos con Nmap podemos scanear por categoria de scripts:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">└─$ nmap <span class=\"token parameter variable\">-sS</span> <span class=\"token parameter variable\">--script</span> <span class=\"token string\">\"vuln,auth\"</span> <span class=\"token parameter variable\">-vv</span> <span class=\"token parameter variable\">--open</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">135,139</span>,445,49152,49153,49154,49155,49156,49157 <span class=\"token parameter variable\">-Pn</span> <span class=\"token parameter variable\">-n</span> <span class=\"token number\">10.10</span>.10.40 <span class=\"token parameter variable\">-oN</span> vuln.ports</code></pre></div>\n<p>De este modo vemos resultados para EternalBlue con los scripts de la categoria vuln de Nmap.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token operator\">|</span> smb-vuln-ms17-010: \n<span class=\"token operator\">|</span>   VULNERABLE:\n<span class=\"token operator\">|</span>   Remote Code Execution vulnerability <span class=\"token keyword\">in</span> Microsoft SMBv1 servers <span class=\"token punctuation\">(</span>ms17-010<span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>     State: VULNERABLE\n<span class=\"token operator\">|</span>     IDs:  CVE:CVE-2017-0143\n<span class=\"token operator\">|</span>     Risk factor: HIGH</code></pre></div>\n<h2>EternalBlue</h2>\n<p>Una idea recurrente en seguridad es reconocer vectores, patrones o versiones vulnerables, de ahi que veamos los resultados de Nmap default y pensemos en probar si el Host es vulnerable a EternalBlue.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">Host script results:\n<span class=\"token operator\">|</span> smb-os-discovery: \n<span class=\"token operator\">|</span>   OS: Windows <span class=\"token number\">7</span> Professional <span class=\"token number\">7601</span> Service Pack <span class=\"token number\">1</span> <span class=\"token punctuation\">(</span>Windows <span class=\"token number\">7</span> Professional <span class=\"token number\">6.1</span><span class=\"token punctuation\">)</span>\n<span class=\"token operator\">|</span>   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional\n<span class=\"token operator\">|</span>   Computer name: haris-PC</code></pre></div>\n<p>Otra traza que nos puede ayudar a advertir EternalBlue es la version 1 de SMB, que podemos obtener con el script <code class=\"language-text\">smb-protocols</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token operator\">|</span> smb-protocols: \n<span class=\"token operator\">|</span>   dialects: \n<span class=\"token operator\">|</span>     NT LM <span class=\"token number\">0.12</span> <span class=\"token punctuation\">(</span>SMBv1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span>dangerous, but default<span class=\"token punctuation\">]</span>\n<span class=\"token operator\">|</span>     <span class=\"token number\">2</span>:0:2\n<span class=\"token operator\">|</span>_    <span class=\"token number\">2</span>:1:0</code></pre></div>\n<h3>Windows 7 Professional Service Pack 1</h3>\n<p>Si el sistema es Windows 7 Professional SP1 es candidato para MS17-010 (EternalBlue) que afecta justamente a SMBv1 en Windows 7/2008R2 y similares.</p>\n<p>Condiciones que te tienen que disparar la alerta “¿MS17-010?”</p>\n<ol>\n<li>Puerto 445/TCP abierto (SMB).</li>\n<li>Sistema operativo en el rango vulnerable:\n<ol>\n<li>Windows 7 (sobre todo SP1).</li>\n<li>Windows Server 2008 / 2008 R2.</li>\n<li>(En entornos más viejos, también XP/2003).</li>\n</ol>\n</li>\n<li>Indicios de SMBv1 habilitado (muy típico en esos sistemas antiguos).</li>\n</ol>\n<p>Un mini-playbook para cualquier objetivo que huela a Windows 7 con SMB:</p>\n<ol>\n<li>Escaneo de puertos: ¿está 445 abierto?</li>\n<li>smb_version o smb-os-discovery: ¿Windows 7 / 2008 R2?</li>\n<li>smb-vuln-ms17-010 o smb_ms17_010: ¿reporta vulnerable?</li>\n</ol>\n<h2>SMB</h2>\n<p>SMB es uno de los vectores de RCE más explotados de Windows en la historia. Si ves SMB en una máquina vieja, piensa que SMB nunca es un puerto “pasivo”:</p>\n<ol>\n<li>¿Es MS17-010?</li>\n<li>¿Es MS08-067?</li>\n<li>¿Hay null session?</li>\n<li>¿Hay shares writeables?</li>\n<li>¿SMBv1 activo?</li>\n</ol>\n<h2>RPC (Remote Procedure Call)</h2>\n<p>RPC es el medio por el cual Windows permite que otras máquinas o procesos remotos llamen a funciones internas del sistema operativo (sobre puertos como 135, 49152–49157 y pipes especiales (IPC$))</p>\n<p><strong>RPC es mucho más que “información”, puede lograr RCE real (exploits RPC)</strong></p>\n<p>Ejemplos reales:</p>\n<ol>\n<li>PrintNightmare (RPC sobre Spooler)</li>\n<li>ZeroLogon (RPC sobre Netlogon/DCERPC)</li>\n<li>PetitPotam (RPC MS-EFSR)</li>\n<li>MS08-067 (RPC sobre SMB)</li>\n<li>DFSCoerce / PrinterBug / etc.</li>\n</ol>\n<h3>Validaciones con rpcclient</h3>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">rpcclient <span class=\"token parameter variable\">-U</span> <span class=\"token string\">\"\"</span> <span class=\"token parameter variable\">-N</span> <span class=\"token operator\">&lt;</span>IP<span class=\"token operator\">></span>\nenumdomusers\nenumdomgroups\nqueryuser <span class=\"token number\">500</span>\nspoolss_enum_printers\neventlog_open Application\neventlog_read <span class=\"token number\">1</span>\nlsaquery\nlookupnames Administrator\nquerydispinfo</code></pre></div>\n<h3>Scripts de Impacket</h3>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">impacket-lookupsid <span class=\"token string\">''</span>@<span class=\"token operator\">&lt;</span>IP<span class=\"token operator\">></span>\nimpacket-samrdump <span class=\"token operator\">&lt;</span>IP<span class=\"token operator\">></span>\nimpacket-rpcdump @<span class=\"token operator\">&lt;</span>IP<span class=\"token operator\">></span>\nimpacket-atexec user:pass@<span class=\"token operator\">&lt;</span>IP<span class=\"token operator\">></span> <span class=\"token string\">\"cmd /c whoami\"</span>\nimpacket-coercer <span class=\"token parameter variable\">-t</span> <span class=\"token operator\">&lt;</span>IP<span class=\"token operator\">></span> <span class=\"token parameter variable\">-p</span> spoolss</code></pre></div>\n<h2>Versiones Compatibles</h2>\n<p>Tanto por Python 2 y Python 3 el script provoca errores, antes de modificar grueso probamos movernos a Python 2 con \"virtualenv\".</p>\n<h3>f-strings sin soporte</h3>\n<p>En este caso, la ultima version de impacket necesaria para ejecutar el script no soporta que impacket utilice f-string sobre Python 2. Basicamente, impacket ha dejado sin soporte Python 2 y crashea.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># f-strings sin soporte</span>\nTraceback <span class=\"token punctuation\">(</span>most recent call last<span class=\"token punctuation\">)</span>:\n    av_pairs<span class=\"token punctuation\">[</span>NTLMSSP_AV_TARGET_NAME<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> f<span class=\"token string\">\"{service}/\"</span>.encode<span class=\"token punctuation\">(</span><span class=\"token string\">'utf-16le'</span><span class=\"token punctuation\">)</span> + av_pairs<span class=\"token punctuation\">[</span>NTLMSSP_AV_DNS_HOSTNAME<span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span>\n                                                   ^\nSyntaxError: invalid syntax</code></pre></div>\n<p>Para resolverlo debemos movernos a una version de impacket que soporte Python 2.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">pip <span class=\"token function\">install</span> <span class=\"token assign-left variable\">impacket</span><span class=\"token operator\">==</span><span class=\"token number\">0.9</span>.21</code></pre></div>\n<h3>can't concat str to byte</h3>\n<p>En Python 3 todo debe ser bytes para operar payloads binarios.\nAl concatenar bytes con una string se produce un error de normalizacion, pack() devuelve bytes, pero <code class=\"language-text\">'A'*0xffde</code> es una string.</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">Traceback <span class=\"token punctuation\">(</span>most recent call last<span class=\"token punctuation\">)</span>:\n  File <span class=\"token string\">\"/home/b45lk/audit/study/OSCP/week01/blue_audit/exploits/EternalBlue.py\"</span>, line <span class=\"token number\">83</span>, <span class=\"token keyword\">in</span> <span class=\"token operator\">&lt;</span>module<span class=\"token operator\">></span>\n    ntfea10000 <span class=\"token operator\">=</span> pack<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;BBH'</span>, <span class=\"token number\">0</span>, <span class=\"token number\">0</span>, 0xffdd<span class=\"token punctuation\">)</span> + <span class=\"token string\">'A'</span>*0xffde\n                 ~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~\nTypeError: can't concat str to bytes</code></pre></div>\n<p>Para resolverlo convertimos la string en formato bytes con prefijo <code class=\"language-text\">b'A'</code> o con encode <code class=\"language-text\">('A' * 0xffde).encode()</code></p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\">ntfea10000 <span class=\"token operator\">=</span> pack<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;BBH'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffdd</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">b'A'</span> <span class=\"token operator\">*</span> <span class=\"token number\">0xffde</span>\nntfea10000 <span class=\"token operator\">=</span> pack<span class=\"token punctuation\">(</span><span class=\"token string\">'&lt;BBH'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0xffdd</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'A'</span> <span class=\"token operator\">*</span> <span class=\"token number\">0xffde</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>'ascii' codec can't decode byte 0xa4</h2>\n<p>Una vez mas, Python 2 falla al manejar bytes y strings. En este caso, analizamos la linea en conflicto:</p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\"><span class=\"token comment\"># El choclisimo de la misma vida nos lleva a la linea que falla (exagere un poco, este error no es tan largo)</span>\nTraceback <span class=\"token punctuation\">(</span>most recent call last<span class=\"token punctuation\">)</span>:\n  File <span class=\"token string\">\"zzz_exploit.py\"</span>, line <span class=\"token number\">1113</span>, <span class=\"token keyword\">in</span> <span class=\"token operator\">&lt;</span>module<span class=\"token operator\">></span>\n  File <span class=\"token string\">\"zzz_exploit.py\"</span>, line <span class=\"token number\">1110</span>, <span class=\"token keyword\">in</span> main\n  File <span class=\"token string\">\"zzz_exploit.py\"</span>, line <span class=\"token number\">981</span>, <span class=\"token keyword\">in</span> exploit\n  File <span class=\"token string\">\"zzz_exploit.py\"</span>, line <span class=\"token number\">545</span>, <span class=\"token keyword\">in</span> exploit_matched_pairs\n  File <span class=\"token punctuation\">..</span>. line <span class=\"token number\">401</span>, <span class=\"token keyword\">in</span> send_nt_trans_secondary\n  File <span class=\"token punctuation\">..</span>. line <span class=\"token number\">397</span>, <span class=\"token keyword\">in</span> create_nt_trans_secondary_packet\n  File <span class=\"token punctuation\">..</span>. line <span class=\"token number\">89</span>, <span class=\"token keyword\">in</span> _put_trans_data\n    <span class=\"token comment\"># error:</span>\n    transData <span class=\"token operator\">+=</span> <span class=\"token punctuation\">(</span>b<span class=\"token string\">'\\x00'</span> * padLen<span class=\"token punctuation\">)</span> + str.encode<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\nUnicodeDecodeError: <span class=\"token string\">'ascii'</span> codec can't decode byte 0x91 <span class=\"token keyword\">in</span> position <span class=\"token number\">2</span>: ordinal not <span class=\"token keyword\">in</span> range<span class=\"token punctuation\">(</span><span class=\"token number\">128</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Tomando como experiencia el caso anterior, podemos pensar que el conflicto sucede porque la salida espera bytes pero los datos son strings. Pero si miramos el codigo vemos que aparentemente todo esta bien codificado.</p>\n<p>Haremos unas pruebas:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\"># ❌ fail: mismo error</span>\n<span class=\"token punctuation\">(</span><span class=\"token string\">'\\x00'</span> <span class=\"token operator\">*</span> padLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># ❌ fail: TypeError: can't multiply sequence by non-int of type 'str'</span>\n<span class=\"token punctuation\">(</span><span class=\"token string\">'\\x00'</span> <span class=\"token operator\">*</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">(</span>padLen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token builtin\">str</span><span class=\"token punctuation\">.</span>encode<span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n<span class=\"token comment\"># ✅ success: data ya era bytes</span>\n<span class=\"token string\">b'\\x00'</span> <span class=\"token operator\">*</span> padLen <span class=\"token operator\">+</span> data</code></pre></div>\n<h3>Modernizando Python 2: Common Crash</h3>\n<p><code class=\"language-text\">str.encode(data)</code> es uno de los crashes más típicos que aparecen al intentar “modernizar” exploits hechos para Python 2.</p>\n<p><code class=\"language-text\">str.encode(data)</code> intenta usar el parámetro data como <em>codec name</em>, no como contenido. Cualquier exploit antiguo que veas con <code class=\"language-text\">str.encode(data)</code> o concatenaciones sin prefijo <code class=\"language-text\">b''</code> está casi garantizado que romperá.</p>\n<p><strong>str.encode(data) produce errores como:</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"sh\"><pre class=\"language-sh\"><code class=\"language-sh\">UnicodeDecodeError: <span class=\"token string\">'ascii'</span> codec can<span class=\"token string\">'t decode byte ...\nTypeError: descriptor '</span>encode<span class=\"token string\">' requires a '</span>str<span class=\"token string\">' object but received '</span>bytes<span class=\"token string\">'\nTypeError: can'</span>t concat str to bytes</code></pre></div>","categories":["KEV","EternalBlue","Windows 7","SMBv1"],"date":"November 21, 2025","description":"How to identify Eternal Blue","id":"38fa1483-9a58-5510-b3c1-aee3fda7b281","keywords":["KEV","EternalBlue","Windows 7","SMBv1"],"slug":"/eternal-blue/","title":"Eternal Blue","readingTime":{"text":"5 min read"}},"listingPagePath":"/blog"}},"staticQueryHashes":["3262260831","948380417"],"slicesMap":{}}